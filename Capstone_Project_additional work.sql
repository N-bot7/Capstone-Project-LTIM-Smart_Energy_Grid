CREATE OR REPLACE STREAM stg_customer_stream
ON TABLE customer_profile;


CREATE OR REPLACE STREAM stg_region_stream
ON TABLE region_hierarchy;

CREATE OR REPLACE STREAM stg_weather_stream
ON TABLE weather_data;

insert into weather_data (RegionID,WEATHERDate,TemperatureC,HumidityPct,WindSpeedkmph,SolarIrradiance) values
(30023,'2025-11-02',29.4,68,12,540),
(30014,'2025-11-01',27.1,72,9,480),
(30015,'2025-11-01',31.0,61,15,620),
(30016,'2025-11-01',26.8,75,8,450),
(30017,'2025-11-01',28.2,70,10,510),
(30018,'2025-11-01',30.5,65,14,600),
(30019,'2025-11-01',25.9,80,7,420),
(30020,'2025-11-01',32.1,58,16,650),
(30021,'2025-11-01',27.7,74,9,500),
(30022,'2025-11-01',29.9,66,11,560);

select * from weather_data;
select * from stg_weather_stream;

CREATE OR REPLACE TASK task_upsert_dim_weather
WAREHOUSE = Capstone
--SCHEDULE = 'USING CRON 5 * * * * Asia/Kolkata'   
SCHEDULE='1 minute'
AS
    MERGE INTO DIM_WEATHER AS T
USING (
    SELECT
        RegionID,
        WEATHERDATE,
        TEMPERATUREC,
        HUMIDITYPCT,
        WINDSPEEDKMPH,
        SOLARIRRADIANCE,
        METADATA$ISUPDATE,
        METADATA$ACTION
    FROM STG_WEATHER_STREAM
) S
ON T.REGION_ID = S.REGIONID
AND T.WEATHER_DATE = S.WEATHERDATE

WHEN MATCHED AND S.METADATA$ISUPDATE = TRUE THEN
    UPDATE SET
        T.TEMPERATURE = S.TEMPERATUREC,
        T.HUMIDITY = S.HUMIDITYPCT,
        T.WIND_SPEED = S.WINDSPEEDKMPH,
        T.SOLAR_INDEX = S.SOLARIRRADIANCE

WHEN NOT MATCHED AND S.METADATA$ACTION = 'INSERT' THEN
    INSERT (REGION_ID, WEATHER_DATE, TEMPERATURE, HUMIDITY, WIND_SPEED, SOLAR_INDEX)
    VALUES (S.REGIONID, S.WEATHERDATE, S.TEMPERATUREC, S.HUMIDITYPCT, S.WINDSPEEDKMPH, S.SOLARIRRADIANCE);

ALTER TASK TASK_UPSERT_DIM_WEATHER suspend;
SELECT * FROM STG_WEATHER_STREAM;

SELECT * FROM DIM_WEATHER;

insert into customer (CustomerID,CustomerName,Email,Phone,ConnectionType,TariffCategory,ContractKVA,RegionID) values
(123463,'Cust_015795','user15795@masked.com',700013317,'Residential','A1',1.54,10191),
(123457,'Cust_000860','user860@masked.com',700013317,'Residential','A1',6.79,10153),
(123458,'Cust_038158','user38158@masked.com',700013317,'Residential','A2',4.89,10137),
(123459,'Cust_044732','user44732@masked.com',700013317,'Residential','A2',5.92,10106),
(123460,'Cust_011284','user11284@masked.com',700013317,'Residential','A2',2.98,10047),
(123461,'Cust_006265','user6265@masked.com',700013317,'Residential','A2',4.22,10109),
(123462,'Cust_016850','user16850@masked.com',700013317,'Residential','A1',2.22,10104),
(337194,'Cust_037194','user37194@masked.com',700013317,'Residential','A2',5.93,10188),
(321962,'Cust_021962','user21962@masked.com',700013317,'Residential','B2',9.08,10022),
(347191,'Cust_047191','user47191@masked.com',700013317,'Commercial','A1',47.12,10117);



select * from stg_customer_stream;

CREATE OR REPLACE TASK task_upsert_dim_CUSTOMER
WAREHOUSE = Capstone
--SCHEDULE = 'USING CRON 5 * * * * Asia/Kolkata'   
SCHEDULE='1 minute'
AS
MERGE INTO DIM_CUSTOMER AS T
USING (
    SELECT
       CUSTOMERID,
       EMAIL,
       PHONE,
       REGIONID,
       METADATA$ISUPDATE,
       METADATA$ACTION
    FROM STG_CUSTOMER_STREAM
) S
ON T.CUSTOMER_ID = S.CUSTOMERID

WHEN MATCHED AND S.METADATA$ISUPDATE = TRUE THEN
    UPDATE SET
        T.CUSTOMER_EMAIL = S.EMAIL,
        T.PHONE = S.PHONE,
        T.REGION_ID = S.REGIONID

WHEN NOT MATCHED AND S.METADATA$ACTION = 'INSERT' THEN
    INSERT (CUSTOMER_ID, CUSTOMER_EMAIL, PHONE, REGION_ID)
    VALUES (S.CUSTOMERID, S.EMAIL, S.PHONE, S.REGIONID);

ALTER TASK TASK_UPSERT_DIM_CUSTOMER suspend;
  select * from STG_CUSTOMER_STREAM;
  
  SELECT * FROM DIM_CUSTOMER;
  

insert into region_hierarchy (RegionID,Country,State,Zone,Branch) values
(10110,'US','SCT','Urban','BR102'),
(10179,'India','TN','Urban','BR179'),
(10092,'UK','SCT','Suburban','BR092');

UPDATE region_hierarchy SET COUNTRY = 'INDIA' WHERE REGIONID = 10108;

select * from stg_region_stream;
select * from dim_region;

CREATE OR REPLACE TASK task_upsert_dim_region
WAREHOUSE = Capstone
--SCHEDULE = 'USING CRON 5 * * * * Asia/Kolkata'   
SCHEDULE='1 minute'
AS
MERGE INTO DIM_REGION AS T
USING (
    SELECT
       REGIONID,
        ZONE,
       COUNTRY,
       STATE,
       BRANCH
        METADATA$ISUPDATE,
        METADATA$ACTION
    FROM STG_REGION_STREAM
) S
ON T.REGION_ID= S.REGIONID
WHEN MATCHED AND S.METADATA$ISUPDATE = TRUE THEN
    UPDATE SET
        T.ZONE=S.ZONE,
        T.COUNTRY=S.COUNTRY,
        T.STATE=S.STATE,
        T.BRANCH=S.BRANCH
       

WHEN NOT MATCHED AND S.METADATA$ACTION = 'INSERT' THEN
    INSERT (REGION_ID,ZONE,COUNTRY,STATE,BRANCH)
    VALUES (S.REGIONID, S.ZONE, S.COUNTRY, S.STATE,S.BRANCH);

ALTER TASK TASK_UPSERT_DIM_REGION SUSPEND;

select * from STG_REGION_STREAM;
SELECT * FROM DIM_REGION;


CREATE OR REPLACE TABLE alert_log (
    REGION_ID STRING,
    TIMESTAMP TIMESTAMP,
    LOAD_MW FLOAT,
    UTILIZATION_PCT FLOAT,
    LOSSES_PCT FLOAT,
    ALERT_TYPE STRING,
    ALERT_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP()
);


